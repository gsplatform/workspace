- hosts: dev
  user: root
  tasks:
    - name: Install epel
      action: command creates=/etc/yum.repos.d/epel.repo rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm

    - name: Append custom database configuration
      shell: "cat {{document_root}}/{{postgresql_conf_append}} >> /vagrant/README.md"

    - name: Install needed packages
      action: yum pkg={{item}} state=installed
      with_items:
        - htop
        - atool
        - python-virtualenv
        - python-setuptools
        - git
        - python-devel
        - rpmdevtools
        - gcc
        - gcc-c++
        - make
        - bison
        - libselinux-python
        - wget
        - vim
        - screen
        - unzip
        - curl

    # Adding new ckaner user
    - user: name=ckaner state=present shell=/bin/bash group=users createhome=yes
    #- user: name=ckaner state=absent

    - name: Stop firewall
      command: service iptables stop

    - name: Disable firewall service
      command: chkconfig iptables off

    - name: Disable selinux
      command: /usr/sbin/setenforce 0

    # Include tasks in the correct order
    # SOLR
    - stat: path=/home/solr/installed
      register: solr

    - include: tasks/solr.yml
      when: solr.stat.exists == False

    # PostgreSQL
    - stat: path=/var/lib/pgsql/9.3/data/pg_hba.conf
      register: postgres

    - include: tasks/postgresql.yml
      when: postgres.stat.exists == False

    # Datapusher
    - stat: path=/var/local/ckan/datapusher/installed
      register: datapusher

    - include: tasks/datapusher.yml
      when: datapusher.stat.exists == False

    # CKAN
    - stat: path=/var/local/ckan/installed
      register: ckan

    - include: tasks/ckan.yml
      when: ckan.stat.exists == False

    # CKAN extension
    - include: tasks/ckanext.yml

    # Apache
    - stat: path=/etc/httpd/conf.d/ckan.conf
      register: apache

    - include: tasks/apache.yml
      when: apache.stat.exists == False
